/*!
Humaine AI Client Side Tracker
Date:2021-08-16 
*/

const accountId=175;var oldSessionId;const BASE_URL="https://dca.dev.nonprod.bodegaswimwear.com/humaine/portal/api",userEventURL=`${BASE_URL}/userEvent`,EVENTS={START:"START",END:"END",NAV:"NAV",PRODVIEW:"PRODVIEW",RATE:"RATE",BUY:"BUY",REVIEW:"REVIEW",ADDCART:"ADDCART",ADDLIST:"ADDLIST",REMLIST:"REMLIST",REMCART:"REMCART",ADDTOCARD:"ADDCART",DISCOVER:"DISCOVER",NEWSLETTER_SUBSCRIBE:"NEWSLETTER_SUBSCRIBE",SEARCH:"SEARCH",MENU:"MENU",BACK_NAV:"BACK_NAV",SAVE_FOR_LATER:"SAVE_FOR_LATER",DELETE:"DELETE",PROD_RETURN:"PROD_RETURN",VISIT_BLOG_POST:"VISIT_BLOG_POST",VISIT_SOCIAL_MEDIA:"VISIT_SOCIAL_MEDIA"},ACTION={ADD:"ADD",REMOVE:"REMOVE"},isCookieePresent=()=>getCookie("humaine_tracker"),startSession=async function(){if(isCookieePresent()){var s=JSON.parse(getCookie("humaine_tracker"));let e=new Date(parseInt(s.session_time)),o=new Date;var n=e.getTime()/1e3,t=o.getTime()/1e3,s=await sessionTimeout();t<n+s?console.warn("Session Alive"):n+s<t&&(endSession(),console.warn("Session End"))}else await creatCookie()},endSession=function(){let e=JSON.parse(getCookie("humaine_tracker"));oldSessionId=e.session_id,userEvent(EVENTS.END),e.session_id=sessionId(),e.session_time=(new Date).getTime(),document.cookie="humaine_tracker="+JSON.stringify(e),getCordinates()},sessionTimeout=async function(){return new Promise((o,e)=>{var s=new XMLHttpRequest;s.open("GET",`${BASE_URL}/sessionTimeout/`+accountId,!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("version","v1"),s.onreadystatechange=function(){var e;4===this.readyState&&(200===this.status?(e=JSON.parse(this.responseText),timeout=e.responseData.timeout,o(timeout)):o(0))},s.send()})};var sessionId=function(){var s=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var o=(s+16*Math.random())%16|0;return s=Math.floor(s/16),("x"==e?o:3&o|8).toString(16)});return accountId+"_"+e};const getIP=async function(){return new Promise((o,e)=>{var s=new XMLHttpRequest;s.open("GET","https://api.ipify.org/?format=json",!0),s.onreadystatechange=function(){var e;4==this.readyState&&(200===this.status?(e=this.responseText,o(e)):o(this.errorText))},s.send()})},creatCookie=async function(){let e=new Date;e.setFullYear(e.getFullYear()+1);var o=JSON.parse(await getIP()).ip.replace(/\./g,""),s=navigator.appVersion.replaceAll(";"," "),s={session_id:sessionId(),session_time:(new Date).getTime(),user_Id:accountId+"_"+navigator.platform+"_"+navigator.appName+"_"+o,device_Id:navigator.platform+"_"+navigator.appName,deviceType:navigator.appName+"_"+s};document.cookie="humaine_tracker="+JSON.stringify(s)+";expires="+e.toGMTString();await getCordinates();console.warn("Session Started..")};async function getCordinates(){let t;return new Promise((s,n)=>{navigator.geolocation.getCurrentPosition(async function(e){lat=e.coords.latitude,long=e.coords.longitude;let o=new XMLHttpRequest;o.open("GET","https://api.bigdatacloud.net/data/reverse-geocode-client?latitude="+lat+"&longitude="+long+"&localityLanguage=en",!0),o.onreadystatechange=async function(){4==this.readyState&&200==this.status?(result=JSON.parse(this.responseText),t={city:result.locality,state:result.principalSubdivision,country:result.countryName,lat:lat,long:long},await setLocationAndUserEvent(t),s()):4==this.readyState&&(console.error(this.errorText),n())},o.send()},async function(e){t={};await setLocationAndUserEvent(t);s()})})}const setLocationAndUserEvent=async function(e){let o=JSON.parse(getCookie("humaine_tracker"));return o.latitude=e.lat,o.longitude=e.long,o.city=e.city,o.state=e.state,o.country=e.country,document.cookie="humaine_tracker="+JSON.stringify(o),userEvent(EVENTS.START)},getCookie=function(e){for(var o=document.cookie.split(";"),s=0;s<o.length;s++){var n=o[s].split("=");if(e==n[0].trim())return decodeURIComponent(n[1])}},userEvent=function(e,o,s,n,t,r,i,a,c,E,u){var l=window.performance.timing.domContentLoadedEventEnd-window.performance.timing.navigationStart,S=JSON.parse(getCookie("humaine_tracker"));const T={accountID:accountId,userID:S.user_Id,eventID:e,sessionID:S.session_id};switch(e){case EVENTS.START:T.city=S.city,T.latitude=S.latitude,T.longitude=S.longitude,T.state=S.state,T.country=S.country,T.deviceId=S.device_Id,T.deviceType=S.deviceType,T.pageLoadTime=l;break;case EVENTS.END:T.deviceId=S.device_Id,T.sessionID=oldSessionId;break;case EVENTS.NAV:if(!o)return void console.log("NAV URL is missing");T.pageURL=o;break;case EVENTS.DISCOVER:case EVENTS.BACK_NAV:if(!o)return void console.log("Page URL is missing");T.pageURL=o;break;case EVENTS.BUY:if(!o&&!s&&!n)return void console.log("ProductID or action is missing");T.productID=o,T.productQuantity=s,T.saleAmount=n;break;case EVENTS.PRODVIEW:case EVENTS.RATE:case EVENTS.REVIEW:case EVENTS.ADDCART:case EVENTS.REMCART:case EVENTS.ADDLIST:case EVENTS.REMLIST:case EVENTS.SAVE_FOR_LATER:case EVENTS.DELETE:case EVENTS.PROD_RETURN:if(!o)return void console.log("Product ID is missing");T.productID=o;break;case EVENTS.MENU:if(!c||!E||!u)return void console.error("menu ID, menu URL,menuName URL is missing");T.menuId=c,T.menuURL=E,T.menuName=u;break;case EVENTS.VISIT_BLOG_POST:if(!t||!r)return void console.log("Post title or Post ID is missing");T.postTitle=t,T.postId=r;break;case EVENTS.VISIT_SOCIAL_MEDIA:if(!a||!i)return void console.error("social media platform, social media URL is missing");T.socialMediaPlateForm=i,T.socialMediaURL=a;break;case EVENTS.NEWSLETTER_SUBSCRIBE:case EVENTS.SEARCH:break;default:return void console.log("Invalid Request")}return new Promise((o,s)=>{let e=new XMLHttpRequest;e.open("POST",`${userEventURL}`,!0),e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("version","v1"),e.onreadystatechange=function(){var e;4===this.readyState&&(e=JSON.parse(this.responseText),200===this.status&&"SUCCESS"==e.status?(console.log(e.responseData),o()):"FAIL"==e.status&&(console.error(e.errorList[0]),s()))},e.send(JSON.stringify(T))})},pageNavigate=function(e){isCookieePresent?e?(userEvent(EVENTS.NAV,e),console.log("Success")):console.error("NAV URL is missing"):console.error("Cookie not present")},viewProduct=function(e){isCookieePresent?e?(userEvent(EVENTS.PRODVIEW,e),console.log("Success")):console.error("ProductID is missing"):console.error("Cookie not present")},cartAction=function(e,o){isCookieePresent?e&&o?o==ACTION.ADD?userEvent(EVENTS.ADDCART,e):o==ACTION.REMOVE&&userEvent(EVENTS.REMCART,e):console.error("ProductID or action is missing"):console.error("Cookie not present")},wishlistAction=function(e,o){isCookieePresent?e&&o?o==ACTION.ADD?userEvent(EVENTS.ADDLIST,e):o==ACTION.REMOVE&&userEvent(EVENTS.REMLIST,e):console.error("ProductID or action is missing"):console.error("Cookie not present")},buyProduct=function(e,o,s,n){isCookieePresent?e&&o&&s?(userEvent(EVENTS.BUY,e,o,s),console.log("Success")):console.error("ProductID ,quantity or sale amount  is missing"):console.error("Cookie not present")},rateProduct=function(e){isCookieePresent?e?(userEvent(EVENTS.RATE,e),console.log("Success")):console.error("ProductID is missing"):console.error("Cookie not present")},reviewProduct=function(e){isCookieePresent?e?userEvent(EVENTS.REVIEW,e):console.error("ProductID is missing"):console.error("Cookie not present")},logout=function(){var e;isCookieePresent&&(e=JSON.parse(getCookie("humaine_tracker")),(oldSessionId=e.session_id)?(userEvent(EVENTS.END),console.log("Logout successfully..")):console.error("Old sessionID is missing"))},discoverNavigate=function(e){isCookieePresent?e?(userEvent(EVENTS.DISCOVER,e),console.log("Success")):console.error("Page URL is missing"):console.error("Cookie not present")},newsletter_subscriber=function(){isCookieePresent?(userEvent(EVENTS.NEWSLETTER_SUBSCRIBE),console.log("Success")):console.error("Cookie not present")},search=function(){isCookieePresent?(userEvent(EVENTS.SEARCH),console.log("Success")):console.error("Cookie not present")},menu=function(e,o,s){isCookieePresent?e&&o&&s?(userEvent(EVENTS.MENU,null,null,null,null,null,null,null,e,o,s),console.log("Success")):console.error("menu ID, menu URL,menuName URL is missing"):console.error("Cookie not present")},backNavigate=function(e){isCookieePresent?e?(userEvent(EVENTS.BACK_NAV,e),console.log("Success")):console.error("Page URL is missing"):console.error("Cookie not present")},saveForLater=function(e){isCookieePresent?e?(userEvent(EVENTS.SAVE_FOR_LATER,e),console.log("Success")):console.error("Page URL is missing"):console.error("Cookie not present")},deleteItem=function(e){isCookieePresent?e?(userEvent(EVENTS.DELETE,e),console.log("Success")):console.error("ProductID is missing"):console.error("Cookie not present")},productReturn=function(e){isCookieePresent?e?(userEvent(EVENTS.PROD_RETURN,e),console.log("Success")):console.error("ProductID is missing"):console.error("Cookie not present")},visitBlogPost=function(e,o){isCookieePresent?e&&o?(userEvent(EVENTS.VISIT_BLOG_POST,null,null,null,e,o),console.log("Success")):console.error("Post Title, Post ID is missing"):console.error("Cookie not present")},visitSocialMedia=function(e,o){isCookieePresent?e&&o?(userEvent(EVENTS.VISIT_SOCIAL_MEDIA,null,null,null,null,null,e,o),console.log("Success")):console.error("social media platform, social media URL is missing"):console.error("Cookie not present")};
